name: MCP Server Test

on: [push, pull_request, workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Setup and run
      run: |
        # Install uv
        curl -LsSf https://astral.sh/uv/install.sh | sh
        export PATH="$HOME/.cargo/bin:$PATH"
        
        # Install dependencies
        echo "üì¶ Installing dependencies..."
        if [ -f "pyproject.toml" ]; then
          uv sync 2>&1 | tail -5
        else
          uv venv && uv pip install "mcp[cli]" httpx
        fi
        echo "‚úÖ Installed"
        
        # Find and run server
        ENTRY=$(find . -name "main.py" -o -name "server.py" | grep -v ".venv" | head -1)
        if [ -z "$ENTRY" ]; then
          echo "‚ùå No main.py or server.py found"
          exit 1
        fi
        
        echo "üöÄ Running: $ENTRY"
        timeout 10 uv run "$ENTRY" 2>&1 | tee output.log &
        sleep 6
        
        if pgrep -f "$ENTRY" >/dev/null; then
          echo "‚úÖ Server running"
          pkill -f "$ENTRY"
        else
          echo "‚ÑπÔ∏è Server may be waiting for stdio (normal for MCP)"
          head -20 output.log
        fi
